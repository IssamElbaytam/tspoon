#!/usr/bin/env node
'use strict';

var fs = require('fs');
var path = require('path');
var minimist = require('minimist');
var listy = require('listy');
var isMarkdown = require('is-md');
var async = require('async');
var GitHubMarkdown = require('./');

var argv = minimist(process.argv.slice(2), {
  alias: {
    t: 'title',
    d: 'dest',
    T: 'template',
    h: 'help',
    v: 'version'
  }
});

if (argv.version) {
  process.stdout.write(require('../package').version + '\n');
  process.exit();
} else if (argv._.length === 0 || argv.help) {
  process.stdout.write(fs.readFileSync(path.join(__dirname, '../usage.txt')));
  process.exit();
}

var options = {
  filter: function filter(p) {
    return isMarkdown(p);
  }
};

listy(argv._, options).then(function (markdowns) {

  async.each(markdowns, function (file, index, files) {

    var config = {
      title: argv.title || path.basename(file, '.md'),
      file: file,
      template: argv.template
    };

    var dest = undefined;
    var filename = path.basename(file, '.md') + '.html';
    if (argv.dest) {
      dest = path.join(path.dirname(argv.dest), filename);
    } else {
      dest = path.join(process.cwd(), filename);
    }

    var ghmd = new GitHubMarkdown(config);
    ghmd.render().then(function (html) {
      fs.writeFileSync(dest, html, {
        encoding: 'utf8',
        flag: 'w'
      });
    });
  }, function (error, result) {
    if (error) {
      throw error;
    }
  });
});